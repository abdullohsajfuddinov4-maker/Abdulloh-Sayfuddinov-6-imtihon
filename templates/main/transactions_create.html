{% extends 'base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏{% endblock %}

{% block extra_css %}
<style>
:root {
    --income: #2ecc71;
    --outcome: #e74c3c;
    --gradient: linear-gradient(135deg, #667eea, #764ba2);
}

.form-container {
    max-width: 600px;
    margin: 40px auto;
    background: #fff;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 15px 35px rgba(0,0,0,.1);
}

.header {
    background: var(--gradient);
    color: #fff;
    padding: 30px;
    text-align: center;
    position: relative;
}
.header h1 { margin: 0; font-size: 22px; }

.back-link {
    position: absolute;
    left: 20px;
    top: 32px;
    color: rgba(255,255,255,.8);
    text-decoration: none;
}

.form-body { padding: 30px; }

.form-group { margin-bottom: 20px; }
label { font-weight: 600; font-size: 14px; margin-bottom: 6px; display: block; }

.form-control {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: 2px solid #eee;
    font-size: 16px;
}
.form-control:focus {
    outline: none;
    border-color: #764ba2;
}

/* –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ */
.type-switch {
    display: flex;
    gap: 12px;
}
.type-btn {
    flex: 1;
    padding: 14px;
    text-align: center;
    border-radius: 12px;
    border: 2px solid #eee;
    cursor: pointer;
    font-weight: 700;
    transition: .3s;
}
.type-btn.income { color: var(--income); }
.type-btn.outcome { color: var(--outcome); }

.type-btn.active.income {
    background: #eafaf1;
    border-color: var(--income);
}
.type-btn.active.outcome {
    background: #fdecec;
    border-color: var(--outcome);
}

/* –°—É–º–º–∞ */
.amount-wrap { position: relative; }
.amount-wrap input {
    font-size: 26px;
    font-weight: 700;
    padding-right: 70px;
}
.currency {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: #667eea;
    color: #fff;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 13px;
}

/* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
.radio {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.hidden { display: none; }

.btn-submit {
    width: 100%;
    padding: 16px;
    border-radius: 12px;
    border: none;
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: .3s;
}
.btn-income { background: var(--income); }
.btn-outcome { background: var(--outcome); }

.btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,.15);
}

.errorlist {
    background: #fff5f5;
    color: var(--outcome);
    padding: 8px;
    border-radius: 8px;
    font-size: 13px;
    margin-top: 6px;
}
</style>
{% endblock %}

{{% block content %}
<div class="form-container">

    <!-- –®–ê–ü–ö–ê -->
    <div class="header">
        <a href="{% url 'wallet_detail' wallet.pk %}" class="back-link">‚Üê –ù–∞–∑–∞–¥</a>
        <h1 id="form-title">üí∞ –ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</h1>
    </div>

    <form method="post" class="form-body" novalidate>
        {% csrf_token %}

        <!-- –ö–ê–†–¢–ê –ö–û–®–ï–õ–¨–ö–ê -->
        <div class="wallet-card">
            <div class="wallet-icon">üí≥</div>
            <div class="wallet-info">
                <div class="wallet-name">{{ wallet.name }}</div>
                <div class="wallet-balance">
                    {{ wallet.balance }} {{ wallet.currency }}
                </div>
            </div>
        </div>

        <!-- –¢–ò–ü -->
        <div class="form-group">
            <label>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ *</label>
            <div class="type-switch">
                <div id="btn-income" class="type-btn income active" onclick="setType('income')">
                    üì• –î–æ—Ö–æ–¥
                </div>
                <div id="btn-outcome" class="type-btn outcome" onclick="setType('outcome')">
                    üì§ –†–∞—Å—Ö–æ–¥
                </div>
            </div>
            <input type="hidden" name="type" id="id_type" value="income">
        </div>

        <input type="hidden" name="wallet" value="{{ wallet.pk }}">

        <!-- –°–£–ú–ú–ê -->
        <div class="form-group">
            <label>–°—É–º–º–∞ *</label>

            <div class="amount-wrap">
                <input
                    type="number"
                    name="amount"
                    id="id_amount"
                    min="1"
                    class="form-control"
                    placeholder="0"
                    required
                >
                <span class="currency">{{ wallet.currency }}</span>
            </div>

            <!-- –ë—ã—Å—Ç—Ä—ã–µ —Å—É–º–º—ã -->
            <div class="quick-amounts">
                <button type="button" onclick="setAmount(1000)">+1 000</button>
                <button type="button" onclick="setAmount(5000)">+5 000</button>
                <button type="button" onclick="setAmount(10000)">+10 000</button>
                <button type="button" onclick="setAmount(50000)">+50 000</button>
            </div>

            <div id="amount-error" class="errorlist hidden">
                –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0
            </div>

            {% if form.amount.errors %}
                <div class="errorlist">{{ form.amount.errors }}</div>
            {% endif %}
        </div>

        <!-- –ö–ê–¢–ï–ì–û–†–ò–Ø -->
        <div class="form-group">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>

            <div class="radio">
                <input type="radio" checked name="cat_mode" onclick="toggleCat(false)">
                <label>–í—ã–±—Ä–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é</label>
            </div>

            <div id="cat-old-box">
                {{ form.category }}
            </div>

            <div class="radio">
                <input type="radio" name="cat_mode" onclick="toggleCat(true)">
                <label>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é</label>
            </div>

            <div id="cat-new-box" class="hidden">
                <input
                    type="text"
                    name="new_category_name"
                    class="form-control"
                    placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
                >
            </div>
        </div>

        <!-- –û–ü–ò–°–ê–ù–ò–ï -->
        <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea
                name="description"
                rows="2"
                class="form-control"
                placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
            ></textarea>
        </div>

        <!-- –ö–ù–û–ü–ö–ê -->
        <button id="submit-btn" type="submit" class="btn-submit btn-income">
            ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Ö–æ–¥
        </button>

    </form>
</div>

<script>
const amountInput = document.getElementById('id_amount');
const amountError = document.getElementById('amount-error');
const submitBtn = document.getElementById('submit-btn');
const title = document.getElementById('form-title');

function setType(type) {
    document.getElementById('id_type').value = type;

    document.getElementById('btn-income').classList.toggle('active', type === 'income');
    document.getElementById('btn-outcome').classList.toggle('active', type === 'outcome');

    submitBtn.className = 'btn-submit ' + (type === 'income' ? 'btn-income' : 'btn-outcome');
    submitBtn.innerText = type === 'income'
        ? '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Ö–æ–¥'
        : 'üí∏ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞—Å—Ö–æ–¥';

    title.innerText = type === 'income'
        ? 'üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞'
        : 'üìâ –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤';
}

function setAmount(value) {
    let current = parseInt(amountInput.value) || 0;
    amountInput.value = current + value;
    validateAmount();
}

function validateAmount() {
    if (amountInput.value <= 0) {
        amountError.classList.remove('hidden');
        submitBtn.disabled = true;
    } else {
        amountError.classList.add('hidden');
        submitBtn.disabled = false;
    }
}

amountInput.addEventListener('input', validateAmount);

function toggleCat(isNew) {
    document.getElementById('cat-old-box').classList.toggle('hidden', isNew);
    document.getElementById('cat-new-box').classList.toggle('hidden', !isNew);

    document.getElementById('id_category').disabled = isNew;
    document.querySelector('[name="new_category_name"]').disabled = !isNew;
}

window.onload = () => {
    setType('income');
    validateAmount();
};
</script>
{% endblock %}

<script>
const btnInc = document.getElementById('btn-income');
const btnOut = document.getElementById('btn-outcome');
const submitBtn = document.getElementById('submit-btn');
const title = document.getElementById('form-title');

function setType(type) {
    document.getElementById('id_type').value = type;

    btnInc.classList.toggle('active', type === 'income');
    btnOut.classList.toggle('active', type === 'outcome');

    submitBtn.className = 'btn-submit ' + (type === 'income' ? 'btn-income' : 'btn-outcome');
    submitBtn.innerText = type === 'income' ? '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Ö–æ–¥' : 'üí∏ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞—Å—Ö–æ–¥';

    title.innerText = type === 'income' ? 'üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞' : 'üìâ –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤';
}

function toggleCat(isNew) {
    document.getElementById('cat-old-box').classList.toggle('hidden', isNew);
    document.getElementById('cat-new-box').classList.toggle('hidden', !isNew);

    document.getElementById('id_category').disabled = isNew;
    document.querySelector('[name="new_category_name"]').disabled = !isNew;
}

window.onload = () => {
    setType('income');
    toggleCat(false);
};
</script>
